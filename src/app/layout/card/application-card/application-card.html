<div class="application-card">
  <div class="card-header">
    <!-- Status badge color and icon -->
    <span class="badge" [ngClass]="currentStatusDetails.colorClass">
      <i [ngClass]="currentStatusDetails.iconClass"></i>
      {{ application.status }}
    </span>
    <div class="last-updated">
      <i class="bi bi-clock"></i>
      <time>{{ lastUpdateTimestamp | date:'short' }}</time>
    </div>
  </div>

  <div class="company-position">
    <div class="company-avatar">
      {{ getInitials(application.company) }}
    </div>
    <div class="position-details">
      <h3>{{ application.position }}</h3>
      <div class="company-link">
        <span>{{ application.company }}</span>
        @if (application.website) {
          <a [href]="application.website" target="_blank" rel="noopener noreferrer">
            <i class="bi bi-box-arrow-up-right"></i>
          </a>
        }
      </div>
    </div>
  </div>

  <div class="progress-indicator">
    <div class="progress-labels">
      <span>Progress</span>
      <span>{{ currentStatusDetails.progress }}%</span>
    </div>
    <!-- Progress bar color and width -->
    <div class="progress-bar-bg">
      <div
        class="progress-bar"
        [ngClass]="currentStatusDetails.colorClass"
        [style.width.%]="currentStatusDetails.progress">
      </div>
    </div>
  </div>

  <div class="status-history">
    <h4>Status History</h4>
    <ul>
      @for (status of application.statusHistory.slice().reverse(); track status; let sIndex = $index) {
        <li>
          <div class="timeline-indicator">
            <div class="bi bi-person-check" [ngClass]="statusDetailsMap[status.status].textClass"></div>
            @if (sIndex !== application.statusHistory.length - 1) {
              <div class="connector"></div>
            }
          </div>
          <div class="status-content">
            <div class="status-row">
              <span>{{ status.status }}</span>
              <time>{{ status.createdAt | date:'shortDate' }}</time>
            </div>
            @if (status.notes) {
              <div class="status-notes">{{ status.notes }}</div>
            }
          </div>
        </li>
      }
    </ul>
  </div>

  <div class="card-footer">
    <div class="dropdown">
      <button (click)="showStatusMenu = !showStatusMenu">
        Change Status <i class="bi bi-chevron-down"></i>
      </button>
      @if (showStatusMenu) {
        <ul class="dropdown-menu">
          @for (statusOption of statuses; track statusOption) {
            <li (click)="openStatusModal(statusOption)">
              @if (application.status === statusOption) {
                <span>âœ“</span>
              }
              {{ statusOption }}
            </li>
          }
        </ul>
      }
    </div>
    <div class="actions">
      <button (click)="onEdit()" title="Edit"><i class="bi bi-pencil"></i></button>
      <button (click)="onDelete()" title="Delete"><i class="bi bi-trash text-danger"></i></button>
    </div>
  </div>
</div>

<!-- Modal for status change -->
@if (showStatusModal) {
  <div class="modal-backdrop"></div>
  <div class="modal-popup">
    <h4>Change Status</h4>
    <p>Are you sure you want to change status to <b>{{ selectedStatus }}</b>?</p>
    <textarea
      [(ngModel)]="statusChangeReason"
      placeholder="Reason for status change..."
      rows="3"
      style="width: 100%; margin-top: 1rem; border-radius: 6px; border: 1px solid #343650; padding: 0.5rem; background: #181a2a; color: #fff;"
    ></textarea>
    <div class="modal-actions">
      <button class="btn btn-primary" (click)="confirmStatusChange()" [disabled]="!statusChangeReason.trim()">Yes, Change</button>
      <button class="btn btn-secondary" (click)="closeStatusModal()">Cancel</button>
    </div>
  </div>
}
